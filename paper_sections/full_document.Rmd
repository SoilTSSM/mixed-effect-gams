---
title: "Hierarchical Generalized Additive Models: an introduction with mgcv"
header-includes: 
  - \usepackage{lineno}
    \usepackage{placeins}
    \linenumbers
compact-title: FALSE
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
documentclass: "article"
classoption: "12pt"
geometry: left=2.5cm,right=2.5cm,top=2.5cm,bottom=2.5cm,headheight=12pt,letterpaper
bibliography: bibliography.bib
csl: peerj.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE, cache=TRUE)
library(mgcv)
library(gamm4)
library(tidyr)
library(ggplot2)
library(viridis)
library(cowplot)
library(kableExtra)
library(knitr)
library(tibble)
library(dplyr)

#Set the default theme for ggplot objects to theme_bw()
theme_set(theme_bw())
theme_update(panel.grid = element_blank())
```

#Abstract

As the amount and quality of ecological data has grown, and
as ecological questions have become increasingly complex, ecological statistics
has moved from linear models to more flexible and structured models, including
hierarchical generalized linear models (HGLMs) to model complex patterns of
variabilty, and generalized additive models (GAMs) to model nonlinear
relationships between covariates and outcomes. In this paper, we discuss an
extension to both those ideas, the hierarchical GAM (HGAM), that allows the user
to model nonlinear functional relationships between covariates and outcomes
where the shape of the function itself varies between different grouping levels
(say between different species in a community, or between different locations on
a landscape). We describe the theoretical connection between these models and
standard HGLMs and GAMs, how to model different assumptions about the degree of
inter-group variability in functional response, and show how HGAMs can be readily fit
using existing GAM software, the mgcv package in R. We also discuss computational
and statistical issues with fitting these models, and demonstrate how to fit HGAMs
on several example datasets. 

```{r child = '01-intro.Rmd'}
```

```{r child = '02-gams.Rmd'}
```

```{r child = '03-hierarchical_gams.Rmd'}
```

```{r child = '04-computational_and_statistical_issues.Rmd'}
```

```{r child = '05-examples.Rmd'}
```

# Conclusions

HGAMs are a powerful tool to model intergroup variability, and we have attempted 
to illustrate some of the range and possibilities that these models are capable
of, how to fit them to real data sets, and some of the issues that may arise during
model fitting and testing. 
This is still an area of active statistical research however, and better ways of specifying these models, and algorithms for fitting them are always improving. 
This paper should be viewed a jumping-off point for these models, rather than an end-point; we refer the reader to the rich literature on GAMs [e.g. @wood_generalized_2017] and functional regression [@ramsay_functional_2005,@kaufman_bayesian_2010, @scheipl_functional_2014] for more on these ideas. 



```{r, results='asis',echo=FALSE, eval=(opts_knit$get('rmarkdown.pandoc.to') == 'latex')}
#This is just to make sure that the figures occur before the bibliography. 
cat('\\FloatBarrier')
```

# Bibliography
